name: Build Packages (Exe, AppImage, Arch)

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  # ==========================================
  # 1. WINDOWS (.exe / .zip)
  # ==========================================
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.4.0'
        modules: 'qt5compat qtshadertools'

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -G "Visual Studio 17 2022"

    - name: Build
      run: cmake --build build --config Release

    - name: Deploy & Package (Zip)
      shell: cmd
      run: |
        mkdir dist
        copy build\Release\appRpnCalcQuick.exe dist\
        windeployqt --qmldir . --no-translations --compiler-runtime dist\appRpnCalcQuick.exe
        
        :: Pakowanie do ZIP (używamy wbudowanego w powershell lub 7z)
        7z a RpnCalcQuick-Windows.zip .\dist\*

    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: RpnCalcQuick-Windows-Zip
        path: RpnCalcQuick-Windows.zip

  # ==========================================
  # 2. ARCH LINUX (.pkg.tar.zst)
  # ==========================================
  build-arch:
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
    - name: Install System Dependencies
      run: |
        pacman -Sy --noconfirm archlinux-keyring
        pacman -Su --noconfirm
        # sudo jest potrzebne do makepkg (nie można budować jako root)
        pacman -S --noconfirm base-devel cmake git sudo qt6-base qt6-declarative qt6-5compat qt6-shadertools

    - uses: actions/checkout@v4
    
    - name: Build Package (makepkg)
      run: |
        # Fix: makepkg nie może działać jako root. Tworzymy usera 'builder'.
        useradd builder -m
        echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
        chmod -R a+rw .
        
        # Uruchamiamy makepkg jako user builder
        # -s: instaluje zależności, -c: czyści po budowie
        su builder -c "makepkg -s --noconfirm"

    - name: Upload Arch Package
      uses: actions/upload-artifact@v4
      with:
        name: RpnCalcQuick-Arch-Pkg
        path: ./*.pkg.tar.zst

  # ==========================================
  # 3. APPIMAGE (Linux Universal)
  # ==========================================
  build-appimage:
    runs-on: ubuntu-latest
    # Budujemy na Ubuntu 20.04/22.04 (nie Arch), żeby AppImage działał na starszych systemach
    steps:
    - uses: actions/checkout@v4

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.4.0'
        modules: 'qt5compat qtshadertools'

    - name: Install Linux Deps
      run: sudo apt-get update && sudo apt-get install -y libgl1-mesa-dev libxkbcommon-x11-0 libegl1-mesa-dev libxcb-xinerama0 libfuse2 file

    - name: Configure & Build
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
        cmake --build build --config Release
        # Instalujemy do folderu AppDir
        make -C build install DESTDIR=AppDir

    - name: Create AppImage
      run: |
        # Pobieramy narzędzia linuxdeploy
        wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
        chmod +x linuxdeploy*.AppImage

        # Ustawiamy zmienną, by deployqt znalazł qmake
        export PATH=$PATH

        # Generowanie AppImage
        # --appdir: gdzie zainstalowaliśmy pliki
        # --plugin qt: automatycznie dołącza biblioteki Qt
        # --output appimage: tworzy plik wyjściowy
        ./linuxdeploy-x86_64.AppImage --appdir build/AppDir --plugin qt --output appimage --icon-file appRpnCalcQuick.png --desktop-file appRpnCalcQuick.desktop

    - name: Upload AppImage
      uses: actions/upload-artifact@v4
      with:
        name: RpnCalcQuick-AppImage
        path: ./*.AppImage
