name: Release Pipeline

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  APP_NAME: RpnCalcQuick
  BUILD_TYPE: Release

jobs:
  # ==========================================
  # 1. WINDOWS
  # ==========================================
  windows:
    name: ðŸªŸ Windows (Exe/Zip)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.8.1'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          modules: 'qt5compat qtshadertools'
          cache: true

      - name: Configure & Build
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -G "Visual Studio 17 2022"
          cmake --build build --config ${{ env.BUILD_TYPE }}

      - name: Package & Deploy
        shell: cmd
        run: |
          mkdir dist
          copy build\${{ env.BUILD_TYPE }}\app${{ env.APP_NAME }}.exe dist\
          
          :: Run windeployqt
          windeployqt --qmldir . --no-translations --compiler-runtime dist\app${{ env.APP_NAME }}.exe
          
          :: --- CLEANUP OF UNNECESSARY FOLDERS ---
          :: Remove network (SSL) and database support, as the app doesn't use them
          if exist dist\tls rmdir /s /q dist\tls
          if exist dist\sqldrivers rmdir /s /q dist\sqldrivers
          if exist dist\networkinformation rmdir /s /q dist\networkinformation
          :: ---------------------------------------

          :: Package to ZIP
          7z a ${{ env.APP_NAME }}-Windows.zip .\dist\*

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-Windows-Zip
          path: ${{ env.APP_NAME }}-Windows.zip

  # ==========================================
  # 2. ARCH LINUX (Native Package)
  # ==========================================
  arch-package:
    name: ðŸ§ Arch Linux (Pkg)
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - name: Prepare System
        run: |
          pacman -Sy --noconfirm archlinux-keyring
          pacman -Su --noconfirm
          pacman -S --noconfirm base-devel cmake git sudo qt6-base qt6-declarative qt6-5compat qt6-shadertools

      - uses: actions/checkout@v4

      - name: Build Package (makepkg)
        run: |
          # Makepkg cannot run as root, so we create a temporary builder user
          useradd builder -m
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chmod -R a+rw .
          su builder -c "makepkg -s --noconfirm"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-Arch-Pkg
          path: ./*.pkg.tar.zst

  # ==========================================
  # 3. APPIMAGE (Arch Environment)
  # ==========================================
  appimage:
    name: ðŸ“¦ AppImage (Universal)
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - name: Install Dependencies
        run: |
          pacman -Sy --noconfirm archlinux-keyring && pacman -Su --noconfirm
          # file, wget, patchelf are required for linuxdeploy
          pacman -S --noconfirm base-devel cmake git wget file patchelf \
            qt6-base qt6-declarative qt6-5compat qt6-shadertools qt6-wayland

      - uses: actions/checkout@v4

      - name: Build & Install to AppDir
        run: |
          # Configuration and build
          cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DCMAKE_INSTALL_PREFIX=/usr
          cmake --build build -j$(nproc)
          
          # CHANGE: Install to AppDir using full path ($PWD)
          # This ensures files go to /home/runner/work/.../AppDir, not ./build/AppDir
          DESTDIR="$PWD/AppDir" cmake --install build

          # Debugging (optional): Show what exactly was installed, to be sure
          echo "=== Content of AppDir ==="
          find AppDir -maxdepth 4

      - name: Prepare Assets
        run: |
          # Install ImageMagick/rsvg-convert to convert SVG to PNG for AppImage
          pacman -S --noconfirm librsvg
          
          # Convert SVG icon to PNG for AppImage (256x256)
          rsvg-convert -w 256 -h 256 icons/RpnCalcQuickIcon.svg -o app${{ env.APP_NAME }}.png
          
          # Note: Desktop file and scalable SVG icon are already installed via CMake
          # but we need PNG for AppImage compatibility
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          cp app${{ env.APP_NAME }}.png AppDir/usr/share/icons/hicolor/256x256/apps/

      - name: Generate AppImage
        env:
          QMAKE: /usr/bin/qmake6
          QML_SOURCES_PATHS: ${{ github.workspace }}
          EXTRA_PLATFORM_PLUGINS: libqwayland.so;libqxcb.so
          APPIMAGE_EXTRACT_AND_RUN: 1
          NO_STRIP: 1
        run: |
          # 1. Download Tools
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage

          # 2. Manual fix for Wayland Plugins
          PLUGINS_SRC=$(qmake6 -query QT_INSTALL_PLUGINS)
          mkdir -p AppDir/usr/plugins
          for folder in wayland-shell-integration wayland-graphics-integration-client wayland-decoration-client; do
            if [ -d "$PLUGINS_SRC/$folder" ]; then
              echo "Copying $folder..."
              cp -a "$PLUGINS_SRC/$folder" AppDir/usr/plugins/
            fi
          done

          # 3. Build AppImage
          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            -e AppDir/usr/bin/app${{ env.APP_NAME }} \
            --plugin qt \
            --output appimage \
            --icon-file app${{ env.APP_NAME }}.png \
            --desktop-file AppDir/usr/share/applications/app${{ env.APP_NAME }}.desktop
            
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-AppImage
          path: ./*.AppImage
